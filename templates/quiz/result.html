{% extends "core.html" %}




{% block javascript %}
<script type="text/javascript" src="/static/js/quiz.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
	google.load("visualization", "1", {packages:["corechart"]});
	google.setOnLoadCallback(function() {
		var rv = new ResultView({id : {{quiz}}});
	});

	var TestResults = Backbone.Model.extend({
		initialize : function(opts) {
			this.quiz = opts.quiz;
		}, 

		url : function() {
			return this.quiz.url() + '/result'
		}
	});




	var ResultView = NiceView.extend({

		el : '#result-body',

		events : _.extend({}, NiceView.prototype.evs, {
		}),

		initialize : function(opts) {
			var that = this;
			this.quiz = new Quiz({id : opts.id});
			this.results = new TestResults({quiz : this.quiz});
			this.results.fetch({
				success : function(result, resp, opts) {
					that.scatterPlot(result);	
					that.columnChart(result);			
				}
			});
		},

		scatterPlot : function(results) {
			var options = {
				title: 'Some Title',
				hAxis: {title: 'Discount Rate'},
				vAxis: {title: 'Years', minValue: 0, maxValue: 15},
				legend: 'none'
			};
			var data = new google.visualization.DataTable();
		    data.addColumn('number', 'Discount');
		    data.addColumn('number', 'Taken Now');
		    data.addColumn('number', 'Taken Later');

		    //True is now, False is later
		    _.each(results.get('questions'), function(result) {
		    	if(result.choice) {
		    		data.addRow([result.discount_rate, result.years, null])
		    	} else {
		    		data.addRow([result.discount_rate, null, result.years])
		    	}
		    });
			var chart = new google.visualization.ScatterChart($('#scatter-plot')[0]);
			chart.draw(data, options);
		},

		columnChart : function(results) {
			var stabilities = [];
			var avg = Math.round(results.get('avg'));
			for(s in results.get('stabilities')) {
				var i = parseInt(s);
				var stability = results.get('stabilities')[s]

				if(avg == i) {
					var arr = [i, 0, stability]
				} else {
					var arr = [i, stability, 0]
				}
				stabilities.push(arr)
			}
	        var data = google.visualization.arrayToDataTable(stabilities);

	        var options = {
	        	isStacked : true,
				title: 'Stability',
				vAxis : {title : 'Count'},
				hAxis: {title: 'Stability'}
	        };

	        var chart = new google.visualization.ColumnChart($('#column-chart')[0]);
	        chart.draw(data, options);
		},




	});


</script>

{% endblock %}



{% block main %}


<div class="row">
	<div class="col col-lg-8 col-offset-2">
		<h2>discount rates.</h2>
	</div>
	<div id="result-body" class="col col-lg-8 col-offset-2">
		<div id="scatter-plot"></div>
		<div id="column-chart"></div>

	</div>

</div>

{% endblock %}