{% extends "core.html" %}




{% block javascript %}
<script type="text/javascript" src="/static/js/quiz.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
	google.load("visualization", "1", {packages:["corechart"]});
	google.setOnLoadCallback(function() {
		var rv = new ResultView({id : {{quiz}}});
	});

	var TestResults = Backbone.Model.extend({
		initialize : function(opts) {
			this.quiz = opts.quiz;
		}, 

		url : function() {
			return this.quiz.url() + '/result'
		}
	});




	var ResultView = NiceView.extend({

		el : '#result-body',

		events : _.extend({}, NiceView.prototype.evs, {
		}),

		initialize : function(opts) {
			var that = this;
			this.quiz = new Quiz({id : opts.id});
			this.results = new TestResults({quiz : this.quiz});
			loadTemplate('result-template', '/static/templates/quiz/result.html');
			this.template = _.template($('#result-template').html());
			this.results.fetch({
				success : function(result, resp, opts) {
					that.scatterPlot(result);	
					that.columnChart(result);			
					that.describe(result);
				}
			});
		},


		describe : function(result) { 

			$('#description').html(this.template(result.toJSON()));


		},

		scatterPlot : function(results) {
			var options = {
				title: 'Your Imputed Discount Rates',
				hAxis: {title: 'Discount Rate'},
				vAxis: {title: 'Years'},
				legend: 'none'
			};
			var data = new google.visualization.DataTable();
		    data.addColumn('number', 'Discount');
		    data.addColumn('number', 'Taken Now');
		    data.addColumn('number', 'Taken Later');

		    //True is now, False is later
		    _.each(results.get('questions'), function(result) {
		    	if(result.choice) {
		    		data.addRow([result.discount_rate, result.years, null])
		    	} else {
		    		data.addRow([result.discount_rate, null, result.years])
		    	}
		    });
			var chart = new google.visualization.ScatterChart($('#scatter-plot')[0]);
			chart.draw(data, options);
		},

		columnChart : function(results) {
			var stabilities = [[0,0,0]];
			var overlap = Math.round(results.get('quiz').overlap);
			for(s in results.get('stabilities')) {
				var i = parseInt(s);
				var stability = results.get('stabilities')[s]
				if(overlap == i) {
					var arr = [i, 0, stability]
				} else {
					var arr = [i, stability, 0]
				}
				stabilities.push(arr);
				
			}
	        var data = google.visualization.arrayToDataTable(stabilities);

	        var options = {
	        	isStacked : true,
				title: 'Consistency',
				vAxis : {title : 'Frequency of Consistency Score'},
				hAxis: {title: 'Number of Times Your Imputed Discount Rates Were Inconsistent', minValue : -.5}
	        };

	        var chart = new google.visualization.ColumnChart($('#column-chart')[0]);
	        chart.draw(data, options);
		},




	});


</script>

{% endblock %}



{% block main %}


<div class="row">
	<div class="col col-lg-8 col-offset-2">
		<h2>Your Results</h2>
	</div>
	<div id="result-body" class="col col-lg-8 col-offset-2">
		<div id="scatter-plot"></div>
		<div id="column-chart"></div>
		<div id="description"></div>

	</div>

</div>

{% endblock %}